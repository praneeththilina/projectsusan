{% extends "layout.html" %}
{% block content %}
    <!-- Bootstrap CSS -->
    {# <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"> #}
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- DataTables JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@^1"></script>
    <style>
        .widget-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .widget {
            flex: 1 1 30%;
            margin: 10px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-radius: 10px;
            background: #fff;
        }
        @media (max-width: 768px) {
            .widget {
                flex: 1 1 45%;
            }
        }
        @media (max-width: 480px) {
            .widget {
                flex: 1 1 100%;
            }
        }
    </style>
    
    <h1>Trade Dashboard</h1>
    
    <div class="widget-container">
        <div class="widget">
            <canvas id="realizedPnlChart"></canvas>
        </div>
        <div class="widget">
            <canvas id="tradeVolumeChart"></canvas>
        </div>
        <div class="widget">
            <canvas id="sideDistributionChart"></canvas>
        </div>
        <div class="widget">
            <canvas id="cumulativeVolumePerCoin "></canvas>
        </div>


    </div>
    
    <h2>Trade Data</h2>
    <div class="table-responsive dark:bg-gray-900 ">
        <table id="tradeTable" class="display responsive nowrap" style="width:100%">
            <thead>
                <tr>
                    <th></th>
                    <th>Timestamp</th>
                    <th>Pair</th>
                    <th>Comment</th>
                    <th>Order ID</th>
                    <th>Status</th>
                    <th>Realized PnL</th>
                    <th>Side</th>
                    <th>Price</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody class="dark:bg-gray-900 text-gray-700 dark:text-gray-700">
            </tbody>
        </table>
    </div>
    
    <script>
        function format(d) {
            return `<table cellpadding="5" cellspacing="0" border="0"">
                <tr>
                    <td>Timestamp:</td>
                    <td>${d.timestamp}</td>
                </tr>
                <tr>
                    <td>Pair:</td>
                    <td>${d.pair}</td>
                </tr>
                <tr>
                    <td>Comment:</td>
                    <td>${d.comment}</td>
                </tr>
                <tr>
                    <td>Order ID:</td>
                    <td>${d.orderid}</td>
                </tr>
                <tr>
                    <td>Status:</td>
                    <td>${d.status}</td>
                </tr>
                <tr>
                    <td>Realized PnL:</td>
                    <td>${d.realized_pnl}</td>
                </tr>
                <tr>
                    <td>Side:</td>
                    <td>${d.side}</td>
                </tr>
                <tr>
                    <td>Price:</td>
                    <td>${d.price}</td>
                </tr>
                <tr>
                    <td>Amount:</td>
                    <td>${d.amount}</td>
                </tr>
            </table>`;
        }

        $(document).ready(function() {
            fetch('/data/trades')
                .then(response => response.json())
                .then(data => {
                    const timestamps = data.map(trade => moment(trade.timestamp));
                    const realizedPnl = data.map(trade => trade.realized_pnl);
                    const tradeVolume = data.map(trade => trade.amount);
                    const sides = data.map(trade => trade.side);

                    const table = $('#tradeTable').DataTable({
                        data: data,
                        columns: [
                            {
                                className: 'dtr-control',
                                orderable: false,
                                data: null,
                                defaultContent: '',
                            },
                            { data: 'timestamp' },
                            { data: 'pair' },
                            { data: 'comment' },
                            { data: 'orderid' },
                            { data: 'status' },
                            { data: 'realized_pnl' },
                            { data: 'side' },
                            { data: 'price' },
                            { data: 'amount' }
                        ],
                        order: [[1, 'desc']],
                        responsive: true
                    });

                    $('#tradeTable tbody').on('click', 'td.dt-control', function () {
                        var tr = $(this).closest('tr');
                        var row = table.row(tr);

                        if (row.child.isShown()) {
                            row.child.hide();
                            tr.removeClass('shown');
                        } else {
                            table.rows('.shown').every(function () {
                                this.child.hide();
                                $(this.node()).removeClass('shown');
                            });
                            row.child(format(row.data())).show();
                            tr.addClass('shown');
                        }
                    });
                    // Filter data for the last month
                    const lastMonthData = data.filter(trade => moment(trade.timestamp).isAfter(moment().subtract(1, 'months')));

                    // Calculate cumulative PnL
                    const cumulativePnL = [];
                    let sum = 0;
                    lastMonthData.forEach(trade => {
                        sum += trade.realized_pnl;
                        cumulativePnL.push(sum);
                    });

                    const realizedPnlChartCtx = document.getElementById('realizedPnlChart').getContext('2d');
                    const realizedPnlChart = new Chart(realizedPnlChartCtx, {
                        type: 'line',
                        data: {
                            labels: lastMonthData.map(trade => moment(trade.timestamp)),
                            datasets: [{
                                label: 'Cumulative Realized PnL',
                                data: cumulativePnL,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                fill: false
                            }]
                        },
                        options: {
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'day'
                                    }
                                },
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    

                    // Group trades by date and sum up the trade volumes for each day
                    const tradeVolumeData = {};
                    lastMonthData.forEach(trade => {
                        const date = moment(trade.timestamp).format('YYYY-MM-DD');
                        if (!tradeVolumeData[date]) {
                            tradeVolumeData[date] = 0;
                        }
                        tradeVolumeData[date] += trade.amount;
                    });

                    // Extract labels and data for the chart
                    const tradeVolumeLabels = Object.keys(tradeVolumeData);
                    const tradeVolumeValues = Object.values(tradeVolumeData);

                    // Create the bar chart
                    const tradeVolumeChartCtx = document.getElementById('tradeVolumeChart').getContext('2d');
                    const tradeVolumeChart = new Chart(tradeVolumeChartCtx, {
                        type: 'bar',
                        data: {
                            labels: tradeVolumeLabels,
                            datasets: [{
                                label: 'Trade Volume',
                                data: tradeVolumeValues,
                                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                borderColor: 'rgba(153, 102, 255, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'day'
                                    }
                                },
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });





                    const sideDistributionCtx = document.getElementById('sideDistributionChart').getContext('2d');
                    const sideDistributionChart = new Chart(sideDistributionCtx, {
                        type: 'pie',
                        data: {
                            labels: ['Buy', 'Sell'],
                            datasets: [{
                                label: 'Trade Sides',
                                data: [
                                    sides.filter(side => side === 'buy').length,
                                    sides.filter(side => side === 'sell').length
                                ],
                                backgroundColor: [
                                    'rgba(54, 162, 235, 0.2)',
                                    'rgba(255, 99, 132, 0.2)'
                                ],
                                borderColor: [
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(255, 99, 132, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            aspectRatio: 1, // Aspect ratio to maintain a square shape
                            responsive: true,
                            maintainAspectRatio: false // Override responsive settings to use aspect ratio
                        }
                    });



                });

            // Dropdown scroll hide using table responsive
            $('.table-responsive').on('show.bs.dropdown', function () {
                $(this).css("overflow", "inherit");
            });

            $('.table-responsive').on('hide.bs.dropdown', function () {
                $(this).css("overflow", "auto");
            });
        });
    </script>

{% endblock content %}
